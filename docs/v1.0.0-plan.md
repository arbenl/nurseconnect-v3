# NurseConnect V3 v1.0.0 Plan (RED -> AMBER -> GREEN)

## Scope
- Stabilize core launch blockers with minimal PRs and deterministic CI.
- Restore build/type integrity for `web`.
- Close authz/data-exposure gaps (`/api/user`, RBAC consistency, 401/403/404 policy).
- Enforce clean-database reproducibility as authoritative for DB/API lanes.
- Make `/api/me` failure semantics truthful and safely handled by clients.
- Add hard, testable release gate command for merge readiness.

## Non-Scope
- Broad UI redesign/polish beyond required error-state compatibility for `/api/me`.
- New product features outside onboarding/request lifecycle hardening.
- Full observability platform expansion (SLO dashboards, tracing rollout) for this phase.

## PR Sequence
1. PR-0: `chore(ci): align pnpm + env validation`
2. PR-1: `fix(web): request-events typing + /api/me truthful failures`
3. PR-2: `security(api): close /api/user leak + RBAC policy matrix`
4. PR-3: `db(nurse): UNIQUE(user_id) + idempotent become-nurse`
5. PR-4: `ci(db): clean DB authority + one-command release gate`

## PR Plan

| PR | Goal | Files likely touched | Implementation approach | Risks | Acceptance criteria | Proof commands / CI lane |
|---|---|---|---|---|---|---|
| PR-0 | Deterministic preflight in CI/local | `.github/workflows/ci.yml`, `package.json`, `scripts/env-check.mjs` (or `scripts/env-validate.mjs`) | Pin CI `pnpm` to `10.15.x` (matching `packageManager`), run env validation early in quality job and locally; ensure CI-required env vars are explicit per lane. | Env checks can initially fail noisy on missing vars. | CI uses same major/minor pnpm as repo; env validation fails fast with actionable message. | `pnpm env:check`; CI `quality` |
| PR-1 | Restore build and honest `/api/me` error contract | `apps/web/src/server/requests/request-events.ts`, `apps/web/src/server/requests/request-events.db.test.ts`, `apps/web/src/app/api/me/route.ts`, `apps/web/src/types/me.ts`, `apps/web/src/hooks/use-user-profile.ts`, `apps/web/src/app/(app)/dashboard/dashboard-client-page.tsx` | Fix Drizzle type flow in request-events query; return `500` + `{ ok:false, error }` on internal `/api/me` failures; make client handle HTTP 500 and `ok:false` without loops/crash; add clear dashboard retry state. Add temporary failure toggle (e.g. `FORCE_API_ME_ERROR=1`) for local verification. | Client regressions if consumers assume `ok:true` always. | Dashboard shows clear "session unavailable / retry"; `useUserProfile` does not infinite-retry/crash; web build/typecheck pass. | `pnpm -w type-check && pnpm --filter web build`; `pnpm --filter web dev` then `curl -i http://localhost:3000/api/me` with forced failure env; CI `quality` |
| PR-2 | Close `/api/user` leak with no user enumeration + normalize RBAC responses | `apps/web/src/app/api/user/route.ts` (lock down), `apps/web/src/server/auth/require-role.ts`, `apps/web/src/server/auth/http.ts`, `apps/web/src/server/auth/index.ts`, request/location route handlers, `apps/web/tests/e2e-api/authz.api.e2e.ts` | Do **not** hard-delete route first. Gate `/api/user` by policy (`admin-only` or `self-only`), no raw ID enumeration. Standardize authz via shared helper and explicit 401/403/404 mapping. Run usage search; if no usage, delete in follow-up PR-2b. | Breaking consumers if route usage exists and not migrated first. | `rg "api/user" -n apps/web` reviewed; if usage exists, migrated first; authz matrix tests cover unauthenticated vs forbidden vs not-found. | `rg "api/user" -n apps/web`; `pnpm gate:e2e-api`; CI `e2e-api` |
| PR-3 | Enforce single nurse profile per user + race-safe onboarding | `packages/database/src/schema/nurses.ts`, `packages/database/drizzle/*0009*`, `apps/web/src/app/api/me/become-nurse/route.ts`, `apps/web/src/app/api/me/nurse/route.ts`, `apps/web/tests/e2e-api/nurse.api.e2e.ts` | Keep schema + migration aligned for uniqueness (`UNIQUE(user_id)` / Drizzle unique index). Deduplicate pre-existing rows in migration before uniqueness. Use conflict-safe upserts for become-nurse/profile updates. | Dedup step removes redundant historical duplicates by policy. | Clean migrate passes; duplicate nurse rows cannot be created; repeated become-nurse remains idempotent with exactly one nurse row. | `pnpm db:from-clean`; `pnpm gate:e2e-api`; SQL: `SELECT count(*) FROM nurses GROUP BY user_id HAVING count(*) > 1;` returns 0; CI `db-integration`,`e2e-api` |
| PR-4 | Make clean DB reproducibility authoritative + safe reset guardrails | `scripts/db-reset-schema.sh`, `package.json`, `.github/workflows/ci.yml` | Require `db:from-clean` before DB/API tests; add one-command gate `pnpm gate:release`; hard guard `db:reset:schema` to refuse non-test DB unless `I_KNOW_WHAT_I_AM_DOING=1`. | Operational risk if guardrails are weak or bypassed accidentally. | Reset script fails non-test URL with clear error; passes for `*_test`; DB/API lanes always start from clean migrate; release gate is deterministic. | Negative test: run `db:reset:schema` on non-test DB -> non-zero; `pnpm gate:release`; CI `db-integration`,`e2e-api`,`e2e-ui-smoke` |

## Go/No-Go Checklist (Launch Day)
- [ ] `pnpm gate:release` passes on `main` with no manual step.
- [ ] `quality`, `unit`, `db-integration`, `e2e-api`, `e2e-ui-smoke` are all green in CI.
- [ ] Clean DB reproducibility proven: `pnpm db:from-clean` passes in CI and local.
- [ ] `/api/me` internal failures return HTTP 5xx and client shows retry-safe UX state.
- [ ] RBAC policy is centralized and matrix-tested (401 vs 403 vs 404).
- [ ] `/api/user` is non-enumerable by policy (or removed only after usage migration proof).
- [ ] `nurses` uniqueness enforced; duplicate audit query returns 0.
- [ ] `db:reset:schema` hard-refuses non-test DB unless `I_KNOW_WHAT_I_AM_DOING=1` is explicitly set.
- [ ] Secrets scan (`gitleaks`) passes and no tracked `.env` artifacts are present.
- [ ] Release notes include rollback command path and DB migration version shipped.

## Release Gate (Single Command)

```bash
pnpm gate:release
```

## Automatic Enforcement
- Install hooks once per clone:
  - `pnpm hooks:install`
- Automated local checks:
  - `.githooks/pre-commit` -> blocks commit if unstaged/untracked files exist.
  - `.githooks/post-commit` -> enforces clean tree immediately after commit.
  - `.githooks/pre-push` -> requires clean tree, runs `pnpm gate:release`, re-checks clean tree, and blocks on unresolved Copilot/Sentry review threads.
  - Emergency local bypasses: `STRICT_GUARD_ALLOW_UNTRACKED=1` (commit hook only) and `STRICT_GUARD_SKIP=1` (skip hook run).
- Automated CI checks:
  - `pr-finalizer` validates required CI checks are green and review conversations are resolved.
  - `pr-finalizer` also runs `scripts/check-pr-bot-comments.mjs` to block unresolved Copilot/Sentry review threads.

## Definition of Done
All required CI lanes green on `main` + clean DB reproducibility passes.
