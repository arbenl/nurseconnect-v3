# PR-3.9 Nurse Location API Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add a nurse-only `PATCH /api/me/location` endpoint with deterministic throttling and tests proving nearest-assignment impact.

**Architecture:** Keep contract-first boundaries: Zod request/response schemas in `packages/contracts`, business rules in a server service, and a thin route handler that maps auth/validation/business errors to HTTP responses. Use DB upsert-on-primary-key for `nurse_locations` and a deterministic throttle window (skip update if last update is too recent).

**Tech Stack:** Next.js App Router, TypeScript, Zod, Drizzle/Postgres, Vitest (node lane), Playwright API E2E.

---

### Task 1: Add RED DB integration tests for nurse location service

**Files:**
- Create: `apps/web/src/server/nurse-location/update-my-location.db.test.ts`

**Step 1: Write the failing test**
- Add tests for:
  - nurse can create location (not throttled)
  - immediate second update is throttled and does not overwrite lat/lng
  - non-nurse user is forbidden

**Step 2: Run test to verify it fails**
- Run: `pnpm --filter web test:api -- src/server/nurse-location/update-my-location.db.test.ts`
- Expected: FAIL due to missing implementation/module.

**Step 3: Write minimal implementation**
- Implement only enough in service + errors to satisfy these tests.

**Step 4: Run test to verify it passes**
- Run same command; expected PASS.

**Step 5: Commit**
- `feat(api): add nurse location service with deterministic throttle`

### Task 2: Add RED API-first E2E for location endpoint and assignment behavior

**Files:**
- Modify: `apps/web/tests/e2e-api/nurse.api.e2e.ts`
- Modify: `apps/web/tests/e2e-api/requests.api.e2e.ts`

**Step 1: Write the failing test**
- Add tests for:
  - `PATCH /api/me/location` rejects patient with `403`
  - two nurses set locations via endpoint and patient request assigns nearest nurse

**Step 2: Run test to verify it fails**
- Run: `pnpm --filter web test:e2e:api -- tests/e2e-api/nurse.api.e2e.ts tests/e2e-api/requests.api.e2e.ts`
- Expected: FAIL (route missing / behavior missing).

**Step 3: Write minimal implementation**
- Add route + contract wiring + service call.

**Step 4: Run test to verify it passes**
- Run same command; expected PASS.

**Step 5: Commit**
- `test(e2e): cover nurse location endpoint and nearest assignment`

### Task 3: Wire contracts and endpoint

**Files:**
- Create: `packages/contracts/src/location.ts`
- Modify: `packages/contracts/src/index.ts`
- Create: `apps/web/src/server/nurse-location/update-my-location.ts`
- Create: `apps/web/src/app/api/me/location/route.ts`

**Step 1: Write/adjust failing unit expectations (if needed)**
- Ensure schemas are imported in route/service usage with type checks.

**Step 2: Run focused API tests**
- `pnpm --filter web test:api -- src/server/nurse-location/update-my-location.db.test.ts`

**Step 3: Implement minimal code**
- Request schema: lat/lng numeric bounds.
- Response schema: `{ ok: true, throttled: boolean, lastUpdated: ISO string }`.
- Service rules:
  - authenticated user required (route)
  - nurse role required
  - nurse profile row must exist
  - upsert location row
  - throttle updates in fixed window

**Step 4: Verify pass**
- Re-run focused tests until green.

**Step 5: Commit**
- `feat(api): add /api/me/location endpoint`

### Task 4: Full verification + docs updates

**Files:**
- Modify: `task.md`
- Modify: `verification_report.md`

**Step 1: Run project verification commands**
- `pnpm -w type-check`
- `pnpm lint`
- `pnpm test:ci`
- `pnpm --filter web test:api`
- `pnpm gate:e2e-api`

**Step 2: Confirm expected output**
- All blocking lanes pass.

**Step 3: Update docs**
- Add PR-3.9 checklist and verification outcomes.

**Step 4: Commit**
- `docs: update task and verification report for PR-3.9`
